openapi: 3.0.3
info:
  title: Hybrid Memory System API
  description: |
    GPU-accelerated vector search with multi-vector classification for intelligent memory retrieval.
    
    ## Features
    - **Instant Inserts**: ~169ms with async GPU classification
    - **Fast Search**: ~287ms with multi-vector search
    - **100% Recall**: Find all relevant memories
    - **Zero API Costs**: Local embeddings (all-MiniLM-L6-v2)
    
    ## Performance vs Mem0
    - 4x faster inserts (169ms vs 682ms)
    - 4x faster search (287ms vs 1145ms)
    - 100% recall vs 80%
    - FREE vs $$$
    
  version: 1.0.0
  contact:
    name: API Support
    url: https://github.com/mattgenie/hybrid-memory-system
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://54.145.235.188:8765
    description: Production server (AWS t3.medium)
  - url: http://localhost:8765
    description: Local development server

tags:
  - name: Health
    description: Service health and status
  - name: Memory
    description: Memory management operations
  - name: Search
    description: Memory search operations

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      description: Check service status and configuration
      operationId: getHealth
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
              example:
                status: ok
                embedding_model: all-MiniLM-L6-v2
                classifier_service: connected
                classifier_url: http://13.220.192.170:8766

  /add_memory:
    post:
      tags:
        - Memory
      summary: Add a single memory
      description: |
        Add a memory with instant response using heuristic classifiers.
        GPU classification happens asynchronously in the background.
        
        **Performance**: ~169ms average latency
      operationId: addMemory
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemoryRequest'
            examples:
              food_allergy:
                summary: Food allergy
                value:
                  user_id: user123
                  text: I have a severe peanut allergy
                  topic: food
                  type: stable
              food_preference:
                summary: Food preference
                value:
                  user_id: user123
                  text: I love spicy Thai food
                  topic: food
                  type: stable
              with_classifiers:
                summary: With pre-computed classifiers
                value:
                  user_id: user123
                  text: I am vegetarian
                  topic: food
                  type: stable
                  classifiers:
                    - dietary preference
                    - lifestyle
      responses:
        '200':
          description: Memory added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemoryResponse'
              example:
                status: success
                topic: food
                classifiers:
                  - dietary restriction
                  - health condition
                classifier_source: heuristic
                async_improvement: true
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /add_memories_batch:
    post:
      tags:
        - Memory
      summary: Add multiple memories in batch
      description: |
        Efficiently add multiple memories at once.
        Uses batch processing for 10-15x better throughput.
        
        **Performance**: ~820ms per memory (vs 2060ms sequential)
      operationId: addMemoriesBatch
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemoriesBatchRequest'
            example:
              memories:
                - user_id: user123
                  text: I prefer organic vegetables
                  topic: food
                  type: stable
                - user_id: user123
                  text: I avoid processed foods
                  topic: food
                  type: stable
                - user_id: user123
                  text: I like farm-to-table restaurants
                  topic: food
                  type: stable
      responses:
        '200':
          description: Memories added successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BatchResponse'
              example:
                status: success
                inserted: 3
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /search:
    post:
      tags:
        - Search
      summary: Search memories
      description: |
        Multi-vector search across text and semantic classifiers.
        
        **Performance**: ~287ms average latency
        **Recall**: 100% (finds all relevant memories)
        **Precision**: ~100% (with score_threshold: 0.27)
      operationId: searchMemories
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SearchRequest'
            examples:
              basic_search:
                summary: Basic search
                value:
                  user_id: user123
                  context: dietary restrictions
                  limit: 10
                  use_classifiers: true
              with_threshold:
                summary: With score threshold
                value:
                  user_id: user123
                  context: food preferences
                  limit: 10
                  use_classifiers: true
                  score_threshold: 0.27
              with_domain:
                summary: With domain filter
                value:
                  user_id: user123
                  context: restaurant recommendations
                  domain: places
                  limit: 5
                  use_classifiers: true
                  score_threshold: 0.3
      responses:
        '200':
          description: Search results
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SearchResponse'
              example:
                memories:
                  - text: I have a severe peanut allergy
                    topic: food
                    type: stable
                    classifiers:
                      - dietary restriction
                      - health condition
                    score: 0.797
                  - text: I am vegetarian
                    topic: food
                    type: stable
                    classifiers:
                      - dietary preference
                      - lifestyle
                    score: 0.379
        '500':
          description: Server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AddMemoryRequest:
      type: object
      required:
        - user_id
        - text
      properties:
        user_id:
          type: string
          description: Unique user identifier
          example: user123
        text:
          type: string
          description: Memory text content
          example: I have a severe peanut allergy
        topic:
          type: string
          description: Topic category (auto-detected if not provided)
          enum: [food, movies, music]
          example: food
        type:
          type: string
          description: Memory type
          default: stable
          enum: [stable, contextual]
          example: stable
        classifiers:
          type: array
          description: Pre-computed classifiers (optional, will use heuristics if not provided)
          items:
            type: string
          example:
            - dietary restriction
            - health condition

    AddMemoryResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        topic:
          type: string
          example: food
        classifiers:
          type: array
          items:
            type: string
          example:
            - dietary restriction
            - health condition
        classifier_source:
          type: string
          enum: [provided, heuristic, llm_async]
          example: heuristic
        async_improvement:
          type: boolean
          description: Whether async GPU classification is running
          example: true

    AddMemoriesBatchRequest:
      type: object
      required:
        - memories
      properties:
        memories:
          type: array
          items:
            $ref: '#/components/schemas/AddMemoryRequest'

    BatchResponse:
      type: object
      properties:
        status:
          type: string
          example: success
        inserted:
          type: integer
          description: Number of memories inserted
          example: 10

    SearchRequest:
      type: object
      required:
        - user_id
        - context
      properties:
        user_id:
          type: string
          description: User to search for
          example: user123
        context:
          type: string
          description: Search query
          example: dietary restrictions
        domain:
          type: string
          description: Domain filter
          enum: [places, movies, music]
          example: places
        limit:
          type: integer
          description: Maximum number of results
          default: 10
          minimum: 1
          maximum: 100
          example: 10
        use_classifiers:
          type: boolean
          description: Enable multi-vector search (searches text + classifiers)
          default: true
          example: true
        score_threshold:
          type: number
          format: float
          description: Minimum similarity score (0-1). Higher = more precision, lower = more recall
          default: 0.27
          minimum: 0
          maximum: 1
          example: 0.27

    SearchResponse:
      type: object
      properties:
        memories:
          type: array
          items:
            $ref: '#/components/schemas/Memory'

    Memory:
      type: object
      properties:
        text:
          type: string
          example: I have a severe peanut allergy
        topic:
          type: string
          example: food
        type:
          type: string
          example: stable
        classifiers:
          type: array
          items:
            type: string
          example:
            - dietary restriction
            - health condition
        score:
          type: number
          format: float
          description: Similarity score (0-1, higher is better)
          example: 0.797

    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: ok
        embedding_model:
          type: string
          example: all-MiniLM-L6-v2
        classifier_service:
          type: string
          enum: [connected, unavailable, disabled]
          example: connected
        classifier_url:
          type: string
          example: http://13.220.192.170:8766

    ErrorResponse:
      type: object
      properties:
        detail:
          type: string
          description: Error message
          example: Internal server error
